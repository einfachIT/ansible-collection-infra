---
# This is an example playbook to execute Ansible tests.

- name: Verify ceph mon1
  hosts: ceph-mon1
  become: true
  gather_facts: false
  tasks:

  - name: Get file status of cephadm binary
    ansible.builtin.stat:
      path: /usr/local/bin/cephadm
    register: cephadm
    changed_when: false

  - name: Check cephadm
    ansible.builtin.assert:
      that: cephadm.stat.exists
    changed_when: false

  - name: Get Info about cluster daemons
    ansible.builtin.command: cephadm ls
    register: daemons
    changed_when: false

  - name: Check running deamons
    ansible.builtin.assert:
      that:
        - daemons.stdout is search("mgr.ceph")
        - daemons.stdout is search("mon.ceph")
    changed_when: false

- name: Verify ceph-cluster
  hosts: ceph-shell
  connection: docker
  gather_facts: false
  remote_user: root
  tasks:
    - name: "Health"
      ansible.builtin.command:
        cmd: "ceph health"
      register: ceph_health
      changed_when: false

    - name: Debug out
      ansible.builtin.debug:
        var: ceph_health.stdout

    - name: Get list of already registered Nodes
      ansible.builtin.command:
        cmd: "ceph orch host ls --format json"
      delegate_to: ceph-shell
      register: osd_info
      changed_when: false

    - name: Assert all nodes are registered
      ansible.builtin.assert:
        that:
          - osd_info.stdout != ""
