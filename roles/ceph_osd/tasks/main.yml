---
- name: Fetch the ssh public key from ceph monitor host
  ansible.builtin.fetch:
    src: "/etc/ceph/ceph.pub"
    dest: "/tmp/ceph_id_rsa.pub"
    flat: true
  delegate_to: ceph-mon1
  run_once: true

- name: Add the key to authorized_keys
  ansible.builtin.authorized_key:
    user: root
    state: present
    key: "{{ lookup('file', '/tmp/ceph_id_rsa.pub') }}"

- name: Get list of already registered Nodes
  ansible.builtin.command:
    cmd: "ceph orch host ls --format json {{ hostname }}"
  delegate_to: ceph-shell
  register: osd_info
  changed_when: false

- name: Add new osd host to ceph cluster
  ansible.builtin.command:
    cmd: "ceph orch host add {{ hostname }} {{ ceph_cluster_network_ip }}"
  delegate_to: ceph-shell
  when: osd_info.stdout == ""
